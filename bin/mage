#!/bin/bash

RESET='\033[0m'
BOLD='\033[1m'
ITALIC='\033[3m'
BLUE='\033[1;34m'

OPTION=${1}
PARAM=${2}

case "${OPTION}" in
  help)
    echo -e "\n${BOLD}Options:${RESET}"
    echo -e "- ${BLUE}open${RESET}    (open store in browser)"
    echo -e "- ${BLUE}config${RESET}  (Set config for developing)"
    echo -e "\n${ITALIC}Anything else will run ${BLUE}bin/magento${RESET}"
    echo -e "${ITALIC}To see those cmd's just run ${BLUE}mage${RESET}"
    ;;
  open)
    STORE=${PARAM:-default}
    ADMIN="$(php bin/magento info:adminuri | cut -d '/' -f2 | tr -d '[:space:]')"

    # Check if secure flag was given
    if [[ "$(php bin/magento config:show web/secure/use_in_frontend)" == "1" ]]; then
      HTTP="secure"
    else
      HTTP="unsecure"
    fi

    # Set url to open
    if [[ "$STORE" == "admin" ]]; then
      URL="$(php bin/magento config:show web/${HTTP}/base_url)${ADMIN}"
    elif [[ "$STORE" == "default" ]]; then
      # Use fast solution
      URL="$(php bin/magento config:show web/${HTTP}/base_url)"
    else
      # Use Slow solution via magerun, but able to get store views
      # TODO: create open without magerun
      # e.g. --scope="store" --scope-code="default"
      URL=$(magerun2 sys:store:config:base-url:list --format csv | grep $STORE | cut -d ',' -f3)
    fi

    # Open url
    if [[ -z "$URL" ]]; then
      echo "Could not find url for store $STORE"
    else
      echo "Opening url $URL";
      open $URL;
    fi
    ;;
  config)
    php bin/magento cache:disable layout block_html full_page;
    echo "setting session lifetime 86400";
    php bin/magento config:set admin/security/session_lifetime 86400;
    echo "setting admin password lifetime âˆž";
    php bin/magento config:set admin/security/password_lifetime "";
    # magerun default is de_DE
    echo "setting general locale to en_US";
    php bin/magento config:set general/locale/code en_US;
    ;;
  *)
    php bin/magento $@
    ;;
esac
